{
  "rules": {
    "users": {
      "$uid": {
        ".read": "auth != null",
        ".write": "auth != null && auth.uid === $uid",
        
        "contacts": { ".read": "$uid === auth.uid", ".write": "$uid === auth.uid" },
        "conversations": { ".read": "$uid === auth.uid", ".write": "auth != null" },
        "presence": { ".read": "auth != null" },
        "groups": { ".write": "auth != null" },

        // --- BU BÖLÜM EKLENDİ ---
        // OneSignal'dan gelen Player ID'lerini kullanıcının kendi
        // profiline yazabilmesi için gerekli izin.
        "playerIds": {
          ".write": "$uid === auth.uid"
        }
        // --- EKLEME SONU ---
      }
    },
    "userSearchIndex": {
      ".read": "auth != null",
      "$uid": {
        ".write": "auth != null && auth.uid === $uid"
      }
    },
    "dms": {
      "$dmId": {
        ".read": "auth != null && $dmId.contains(auth.uid)",
        ".write": "auth != null && $dmId.contains(auth.uid)",
        
        // --- BU BÖLÜM GÜNCELLENDİ/EKLENDİ ---
        // Bu kural, sohbete dahil olan bir kullanıcının,
        // sohbetteki belirli bir mesaj üzerinde yazma (güncelleme)
        // yetkisine sahip olduğunu açıkça belirtir. "Görüldü"
        // bilgisinin güncellenmesini sağlayan kritik kural budur.
        "messages": { 
          ".indexOn": "timestamp",
          "$messageId": {
            ".write": "auth != null && $dmId.contains(auth.uid)"
          }
        }
        // --- GÜNCELLEME SONU ---
      }
    },
    "groups": {
      "$groupId": {
        ".read": "data.child('meta/members').child(auth.uid).exists()",
        "meta": {
          ".write": "root.child('groups/' + $groupId + '/meta/members/' + auth.uid).val() === 'creator' || root.child('groups/' + $groupId + '/meta/members/' + auth.uid).val() === 'admin'"
        },
        "channels": {
          ".write": "root.child('groups/' + $groupId + '/meta/members/' + auth.uid).val() === 'creator' || root.child('groups/' + $groupId + '/meta/members/' + auth.uid).val() === 'admin'"
        },
        "voiceChannels": {
          ".write": "root.child('groups/' + $groupId + '/meta/members/' + auth.uid).val() === 'creator' || root.child('groups/' + $groupId + '/meta/members/' + auth.uid).val() === 'admin'",
          "$channelId": {
            "members": {
              ".write": "root.child('groups/' + $groupId + '/meta/members/' + auth.uid).exists()",
              "$uid": {
                ".validate": "$uid === auth.uid"
              }
            }
          }
        }
      }
    },
    "typing": {
      "dm": {
        "$dmId": {
          ".read": "auth != null && $dmId.contains(auth.uid)",
          "$userId": { ".write": "auth != null && $userId === auth.uid" }
        }
      },
      "group": {
        "$groupId": {
          ".read": "auth != null && root.child('groups/' + $groupId + '/meta/members/' + auth.uid).exists()",
          "$userId": { ".write": "auth != null && $userId === auth.uid" }
        }
      }
    },
    "calls": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "auth != null"
      }
    },
    "challenges": { "$uid": { ".read": "$uid === auth.uid", "$challenger_game_id": { ".write": "auth != null" } } },
    "chess_games": {
      ".read": "auth != null",
      "$gameId": { ".write": "auth != null" }
    }
  }
}